## 初始化
ImSDK 一切操作都是由通讯管理器 `TIMManager` 开始，SDK 操作第一步需要获取 `TIMManager` 单例。

**原型：**
```
@interface TIMManager : NSObject
/**
 *  获取管理器实例
 *
 *  @return 管理器实例
 */
+(TIMManager*)sharedInstance;
@end
```

**示例：**
```
TIMManager * manager = [TIMManager sharedInstance];
```
在使用 SDK 进一步操作之前，需要初始 SDK。

**原型:**
```
@interface TIMManager : NSObject

/**
 *  初始化 SDK
 *
 *  @param config      配置信息，全局有效
 *
 *  @return 0 成功
 */
- (int)initSdk:(TIMSdkConfig*)config;
@end
```
**示例：**
```
TIMSdkConfig *sdkConfig = [[TIMSdkConfig alloc] init];
sdkConfig.sdkAppId = 123456789;
sdkConfig.accountType = @"123";
[[TIMManager sharedInstance] initSdk:sdkConfig];
```
**更多初始化操作请参考 [初始化](https://cloud.tencent.com/document/product/269/9148)**

## 登录/登出
### 登录
用户登录腾讯后台服务器后才能正常收发消息，登录需要用户提供 `accountType`、`identifier`、`userSig`。如果用户保存用户票据，可能会存在过期的情况，如果用户票据过期，`login` 将会返回 `70001` 错误码，开发者可根据错误码进行票据更换。登录为异步过程，通过回调函数返回是否成功，成功后方能进行后续操作。登录成功或者失败后使用闭包 `succ` 和 `fail` 进行回调。

> **注意：**
>- 如果此用户在其他终端被踢，登录将会失败，返回错误码（`ERR_IMSDK_KICKED_BY_OTHERS：6208`）。开发者必须进行登录错误码 `ERR_IMSDK_KICKED_BY_OTHERS` 的判断。关于被踢的详细描述，参见 [用户状态变更](/doc/product/269/9148#5.-.E7.94.A8.E6.88.B7.E7.8A.B6.E6.80.81.E5.8F.98.E6.9B.B4)。
>- 只要登录成功以后，用户没有主动登出或者被踢，网络变更会自动重连，无需开发者关心。不过特别需要注意被踢操作，需要注册 [用户状态变更回调](/doc/product/269/9148#5.-.E7.94.A8.E6.88.B7.E7.8A.B6.E6.80.81.E5.8F.98.E6.9B.B4)，否则被踢时得不到通知。

**原型：**

```
/**
*  登录信息
*/
@interface TIMLoginParam : NSObject
/**
* 用户名
*/
@property(nonatomic,retain) NSString* identifier;
/**
*  鉴权 Token
*/
@property(nonatomic,retain) NSString* userSig;
/**
*  App 用户使用 OAuth 授权体系分配的 Appid
*/
@property(nonatomic,retain) NSString* appidAt3rd;
@end
```

在自有帐号情况下，`appidAt3rd` 字段与 `sdkAppId` 相同，其他字段 `identifier`、`userSig` 填写相应内容。

```
/**
 *登录
 *
 *  @param param 登录参数
 *  @param succ  成功回调
 *  @param fail  失败回调
 *
 *  @return 0 请求成功
 */
- (int)login:(TIMLoginParam*)param succ:(TIMLoginSucc)succ fail:(TIMFail)fail;
@end
```

**参数说明：**

参数|说明
---|---
param | 登录参数，详细信息参见 TIMLoginParam 结构说明
succ | 登录成功回调
fail | 登录失败回调

**示例：**

```
TIMLoginParam * login_param = [[TIMLoginParam alloc ]init];
// identifier 为用户名，userSig 为用户登录凭证
// appidAt3rd 在私有帐号情况下，填写与 sdkAppId 一样
login_param.identifier = @"iOS_001";
login_param.userSig = @"usersig";
login_param.appidAt3rd = @"123456";
[[TIMManager sharedInstance] login: login_param succ:^(){
NSLog(@"Login Succ");
} fail:^(int code, NSString * err) {
NSLog(@"Login Failed: %d->%@", code, err);
}];
```

### 登出

如用户主动注销或需要进行用户的切换，则需要调用注销操作。

**原型：**

```
@interface TIMManager : NSObject
/**
 *  登出
 *
 *  @param succ 成功回调，登出成功
 *  @param fail 失败回调，返回错误码和错误信息
 *
 *  @return 0 发送登出包成功，等待回调
 */
- (int)logout:(TIMLoginSucc)succ fail:(TIMFail)fail; 
@end
```

**示例：**

> **注意：**
> 在需要切换帐号时，需要 `logout` 回调成功或者失败后才能再次 `login`，否则 `login`可能会失败。

```
[[TIMManager sharedInstance] logout:^() {
NSLog(@"logout succ");
} fail:^(int code, NSString * err) {
NSLog(@"logout fail: code=%d err=%@", code, err);
}];
```
**更多登录操作请参考 [登录](https://cloud.tencent.com/document/product/269/9149)**

## 消息发送

### 通用消息发送

#### 会话获取

会话是指面向一个人或者一个群组的对话，通过与单个人或群组之间会话收发消息，发消息时首先需要先获取会话，获取会话需要指定会话类型（群组或者单聊），以及会话对方标志（对方帐号或者群号）。获取会话由 `getConversation` 实现。

**原型：** 

```
@interface TIMManager : NSObject
/**
 *  获取会话
 *
 *  @param type 会话类型，TIM_C2C 表示单聊 TIM_GROUP 表示群聊
 *              TIM_SYSTEM 表示系统会话
 *  @param receiver C2C 为对方用户 identifier，GROUP 为群组 ID，SYSTEM 为空字符串
 *  @return 会话对象
 */
- (TIMConversation*)getConversation:(TIMConversationType)type receiver:(NSString*)receiver;
@end
```

**参数说明： **

参数 | 说明
---|---
type | 会话类型，如果是单聊，填写 TIM_C2C，如果是群聊，填写 TIM_GROUP 
receiver | 会话标识，单聊情况下，receiver 为对方帐号 identifier，群聊情况下，receiver 为群组 ID 

**获取对方 `identifier` 为『iOS-001』的单聊会话示例： **

```
TIMConversation * c2c_conversation = [[TIMManager sharedInstance] getConversation:TIM_C2C receiver:@"iOS-001"];
```

**获取群组 ID 为『TGID1JYSZEAEQ』的群聊会话示例：** 

```
TIMConversation * grp_conversation = [[TIMManager sharedInstance] getConversation:TIM_GROUP receiver:@"TGID1JYSZEAEQ"];
```

#### 消息发送

通过 `TIMManager` 获取会话 `TIMConversation` 后，可发送消息和获取会话缓存消息。ImSDK 中消息的解释可参阅 [ImSDK 对象简介](/doc/product/269/9147#imsdk-.E5.AF.B9.E8.B1.A1.E7.AE.80.E4.BB.8B)。 ImSDK 中的消息由 `TIMMessage` 表达， 一个 `TIMMessage` 由多个 `TIMElem` 组成，每个 `TIMElem` 可以是文本和图片，也就是说每一条消息可包含多个文本和多张图片。发消息通过 `TIMConversation` 的成员 `sendMessage` 实现。有两种方式实现，一种使用闭包，另一种调用方实现 `protocol` 回调。

![](//mccdn.qcloud.com/static/img/7226ab79d4294cc53980c888892f5c6d/image.png)

**原型：**

```
@interface TIMConversation : NSObject
/**
 *  发送消息
 *
 *  @param msg  消息体
 *  @param succ 发送成功时回调
 *  @param fail 发送失败时回调
 *
 *  @return 0 本次操作成功
 */
- (int)sendMessage:(TIMMessage*)msg succ:(TIMSucc)succ fail:(TIMFail)fail;
@end
```

**参数说明：**

参数 | 说明
---|---
msg | 消息 
succ | 成功回调 
fail | 失败回调  

### 文本消息发送

文本消息由 `TIMTextElem` 定义。

```
/**
*  文本消息 Elem
*/
@interface TIMTextElem : TIMElem
/**
*  消息文本
*/
@property(nonatomic,retain) NSString * text;
@end
```

**示例：**

> 注：
>- text 传递需要发送的文本消息。
>- 失败回调中，code 表示错误码，具体可参阅 [错误码](/doc/product/269/1671)，err 表示错误描述。

```
TIMTextElem * text_elem = [[TIMTextElem alloc] init];
[text_elem setText:@"this is a text message"];
TIMMessage * msg = [[TIMMessage alloc] init];
[msg addElem:text_elem];
[conversation sendMessage:msg succ:^(){
NSLog(@"SendMsg Succ");
}fail:^(int code, NSString * err) {
NSLog(@"SendMsg Failed:%d->%@", code, err);
}];
```

**更多消息发送操作请参考 [消息收发](https://cloud.tencent.com/document/product/269/9150)**

## 消息接收
在多数情况下，用户需要感知新消息的通知，这时只需注册新消息通知回调 `TIMMessageListener`，在用户登录状态下，会拉取离线消息，为了不漏掉消息通知，需要在登录之前注册新消息通知。

**原型：**

```
/**
*  消息回调
*/
@protocol TIMMessageListener <NSObject>
@optional
/**
*  新消息回调通知
*
*  @param msgs 新消息列表，TIMMessage 类型数组
*/
- (void)onNewMessage:(NSArray*) msgs;
@end

@interface TIMManager : NSObject

/**
*  添加消息回调（重复添加无效）
*
*  @param listener 回调
*
*  @return 成功
*/
- (int)addMessageListener:(id<TIMMessageListener>)listener;

@end
```

回调消息内容通过参数 `TIMMessage` 传递，通过 `TIMMessage` 可以获取消息和相关会话的详细信息，如消息文本，语音数据，图片等。以下示例中设置消息回调通知，并且在有新消息时直接打印消息。详细可参阅 [消息解析](/doc/product/269/9150#.E6.B6.88.E6.81.AF.E8.A7.A3.E6.9E.90) 部分。

**示例：**

```
@interface TIMMessageListenerImpl : NSObject
- (void)onNewMessage:(TIMMessage*) msg;
@end
@implementation TIMMessageListenerImpl
- (void)onNewMessage:(NSArray*) msgs {
NSLog(@"NewMessages: %@", msgs);
}
TIMMessageListenerImpl * impl = [[TIMMessageListenerImpl alloc] init];
[[TIMManager sharedInstance] addMessageListener:impl];
@end
```
**更多消息接收操作请参考 [消息收发](https://cloud.tencent.com/document/product/269/9150)**

## 群组管理
IM 云通讯有多种群组类型，其特点以及限制因素可参考 [群组系统](/doc/product/269/群组系统)。群组使用唯一 ID 标识，通过群组 ID 可以进行不同操作，其中群组相关操作都由 `TIMGroupManager` 实现，需要用户登录成功后操作。

**获取单例原型：**

```
@interface TIMGroupManager : NSObject
+ (TIMGroupManager*)sharedInstance;
@end
```

### 创建群组

云通信中内置了私有群、公开群、聊天室、互动直播聊天室和在线成员广播大群五种群组类型，详情请见 [群组形态介绍](/doc/product/269/群组系统#.E7.BE.A4.E7.BB.84.E5.BD.A2.E6.80.81.E4.BB.8B.E7.BB.8D)。创建时可指定群组名称以及要加入的用户列表，创建成功后返回群组 ID，可通过群组 ID 获取 `Conversation` 收发消息等。

**创建群组说明：**

| 方法 | 说明 |
| --- | --- |
| CreatePrivateGroup | 创建私有群 |
| CreatePublicGroup | 创建公开群 |
| CreateChatRoomGroup | 创建聊天室 |
| CreateAVChatRoomGroup | 创建直播大群，此类型群可以加入人数不做限制，但是有一些能力上的限制，如不能拉人，不能查询总人数等，可参阅 [直播场景下的 IM 集成方案](/doc/product/269/4104) |

**原型：**

```
@interface TIMGroupManager (Ext)
/**
 *  创建私有群
 *
 *  @param members   群成员，NSString* 数组
 *  @param groupName 群名
 *  @param succ      成功回调
 *  @param fail      失败回调
 *
 *  @return 0 成功
 */
- (int)createPrivateGroup:(NSArray*)members groupName:(NSString*)groupName succ:(TIMCreateGroupSucc)succ fail:(TIMFail)fail;
/**
*  创建公开群
*
*  @param members   群成员，NSString* 数组
*  @param groupName 群名
*  @param succ      成功回调
*  @param fail      失败回调
*
*  @return 0 成功
*/
- (int)createPublicGroup:(NSArray*)members groupName:(NSString*)groupName succ:(TIMCreateGroupSucc)succ fail:(TIMFail)fail;
/**
 *  创建聊天室
 *
 *  @param members   群成员，NSString* 数组
 *  @param groupName 群名
 *  @param succ      成功回调
 *  @param fail      失败回调
 *
 *  @return 0 成功
 */
- (int)createChatRoomGroup:(NSArray*)members groupName:(NSString*)groupName succ:(TIMCreateGroupSucc)succ fail:(TIMFail)fail;
/**
 *  创建音视频聊天室（可支持超大群，详情可参考wiki文档）
 *
 *  @param groupName 群名
 *  @param succ      成功回调
 *  @param fail      失败回调
 *
 *  @return 0 成功
 */
- (int)createAVChatRoomGroup:(NSString*)groupName succ:(TIMCreateGroupSucc)succ fail:(TIMFail)fail;
@end
```

**参数说明：**

参数 | 说明
---|---
members | NSString 列表，指定加入群组的成员，创建者默认加入，无需指定（公开群、聊天室、私有群内最多 10000 人，直播大群没有限制） 
groupName | NSString 类型，指定群组名称（最长 30 字节） 
groupId | NSString 类型，指定群组 ID
succ | 成功回调，返回群组 ID 
fail | 失败回调

以下示例创建一个私有群组，并且把用户『iOS_002』拉入群组。 **示例：**

> 注：
>- 创建者默认加入群组，无需显式指定。
>- 公开群和聊天室调用方式和参数相同，仅方法名不同。 

```
NSMutableArray * members = [[NSMutableArray alloc] init];
// 添加一个用户 iOS_002
[members addObject:@"iOS_002"];
[[TIMGroupManager sharedInstance] createPrivateGroup:members groupName:@"GroupName" succ:^(NSString * group) {
NSLog(@"create group succ, sid=%@", group);
} fail:^(int code, NSString* err) {
NSLog(@"failed code: %d %@", code, err);
}];
```

### 群组消息 
群组消息与 C2C （单聊）消息相同，仅在获取 `Conversation` 时的会话类型不同，可参照 [消息发送](/doc/product/269/9150#.E6.B6.88.E6.81.AF.E5.8F.91.E9.80.81) 部分。

**更多群组操作请参考 [群组管理](https://cloud.tencent.com/document/product/269/9152)**


